<!DOCTYPE html>
<html>
  <head>
    <title>Mirobot Updater</title>
    <style>
    body {
      background-color: #FFF;
      font-family: Lucida Sans Unicode, Lucida Grande, sans-serif;
      font-size: 100%;
    }
    #header .name{
      margin-top:35px;
      float:right;
    }
    .bad{
      color: #F00;
    }
    .good{
      color: #0C0;
    }
    #message{
      background-color:#EEE;
      color:#666;
      font-weight: bold;
      font-size:80%;
      padding:3px;
    }
    #versions{
      width:100%;
    }
  </style>
  </head>
  <body>
    <div id="header">
    <img src="logo.png" />
    <span class="name">Update Tool</span>
    </div>
    <p id="message"></p>
    <p>Mirobot IP address: <input id="ip" type="text" value="10.10.100.254" /> <button class="connect" disabled="disabled">Connect</button></p>
    <table id="versions">
    <tr><td>Arduino Version:</td><td id="arduinoVersion"> </td><td><button class="updateArduino" disabled="true">Update</button></td></tr>
    <tr><td>UI Version:</td><td id="uiVersion"> </td><td><button class="updateUI" disabled="true">Update</button></td></tr>
    </table>
  </body>
  <script>
    var ipc = require('ipc');
    var versions = {};
    
    var updateVersions = function(){
      document.getElementById('arduinoVersion').innerHTML = (versions.arduino ? versions.arduino : 'Unknown');
      document.getElementById('uiVersion').innerHTML = (versions.ui ? versions.ui : 'Unknown');
      if(versions.arduino && versions.arduinoLatest){
        document.getElementById('arduinoVersion').className = (versions.arduino >= versions.arduinoLatest ? 'good' : 'bad');
        document.querySelector('button.updateArduino').disabled = (versions.arduino >= versions.arduinoLatest);
      }
      if(versions.ui && versions.uiLatest){
        if(versions.ui === 'unknown'){
          document.querySelector('button.updateUI').disabled = false;
        }else{
          document.getElementById('uiVersion').className = (versions.ui >= versions.uiLatest ? 'good' : 'bad');
          document.querySelector('button.updateUI').disabled = (versions.ui >= versions.uiLatest);
        }
      }
    }
    
    var setMessage = function(msg){
      document.getElementById('message').innerHTML = msg;
    }
    
    ipc.on('versions', function(v) {
      versions = JSON.parse(v);
      updateVersions();
    });
    
    ipc.on('ready', function() {
      document.querySelector('button.connect').disabled = false;
      setMessage("Ready");
    });
    
    ipc.on('connected', function() {
      document.querySelector('button.connect').innerHTML = 'Connected';
      setMessage("Connected to Mirobot");
    });
    
    ipc.on('status', function(msg) {
      msg = JSON.parse(msg);
      setMessage(msg.msg);
    });
    
    ipc.on('updateArduino', function(msg){
      msg = JSON.parse(msg);
      if(msg.state === 'starting'){
        document.querySelector('button.updateArduino').disabled = true;
        setMessage('Updating Arduino');
      }else if(msg.state === 'progress'){
        setMessage('Updating Arduino: ' + msg.amount + '%');
      }else if(msg.state === 'success'){
        setMessage('Arduino successfully updated');
      }else if(msg.state === 'resetbutton'){
        setMessage('Press the reset button now');
      }else if(msg.state === 'error'){
        document.querySelector('button.updateArduino').disabled = false;
        setMessage('Error updating Arduino');
      }else if(msg.state === 'connecterror'){
        document.querySelector('button.updateArduino').disabled = false;
        setMessage('Error connecting to Arduino');
      }
    });
    
    document.querySelector('button.connect').addEventListener('click', function(){
      setMessage("Connecting to Mirobot");
      ipc.send('connect', document.getElementById('ip').value);
    });
    
    document.querySelector('button.updateArduino').addEventListener('click', function(){
      if(window.confirm("WARNING: Updating the arduino over WiFi carries the risk of breaking Mirobot. You may need to buy a USB to Serial converter if it does not work. Press OK to update the firmware or cancel to abort")){
        ipc.send('updateArduino');
      }
    });
    
    document.querySelector('button.updateUI').addEventListener('click', function(){
      ipc.send('updateUI');
    });
    
    updateVersions();
  </script>
</html>